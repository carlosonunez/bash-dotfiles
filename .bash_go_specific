#!/usr/bin/env bash
export IN_LOCAL_GVM=false
export LOCAL_GVM_NAME=""
GVM_HOOK_CHECK_SENTINEL_FILE=/tmp/gvm_hook_installation_in_progress
GOLANG_VERSION=1.17.1
GOTOOLS=$(cat <<-GOTOOLS
gopls:golang.org/x/tools/gopls@latest
golangci-lint:github.com/golangci/golangci-lint/cmd/golangci-lint@v1.42.1
authy:github.com/momaek/authy@v0.1.7
GOTOOLS
)

trap "rm -rf $GVM_HOOK_CHECK_SENTINEL_FILE" INT EXIT

gvm_hook_check_mutex_lock() {
  printf $$ >> "$GVM_HOOK_CHECK_SENTINEL_FILE"
}

gvm_hook_check_mutex_unlock() {
  rm -f "$GVM_HOOK_CHECK_SENTINEL_FILE"
}

gvm_hook_is_locked() {
  random_wait_time=$(bc -l <<< "scale=4 ; ${RANDOM}/32767")
  sleep "$random_wait_time" && test -e "$GVM_HOOK_CHECK_SENTINEL_FILE"
}

get_gvm_hook_process_holding_lock() {
  cat "$GVM_HOOK_CHECK_SENTINEL_FILE"
}

remove_dead_gvm_install_locks() {
  bash_processes_holding_lock() {
    ps -ef | grep bash | grep -q "$(get_gvm_hook_process_holding_lock)"
  }
  if gvm_hook_is_locked 
  then
    if ! bash_processes_holding_lock
    then
      gvm_hook_check_mutex_unlock 
    fi
  fi
}

gvm_hook() {
  if gvm_hook_is_locked
  then
    log_error "gvm-hook is working in another window"
    return 0
  fi
  if ! test -f "${PWD}/.gvm_local"
  then
    if grep -Eiq '^true$' <<< "$IN_LOCAL_GVM"
    then
      gvm use "go$GOLANG_VERSION" >/dev/null
      export IN_LOCAL_GVM=false
      export LOCAL_GVM_NAME=""
    fi
    return 0
  fi
  
  gvm_hook_check_mutex_lock
  gvm_use_statement=$(tail -1 "${PWD}/.gvm_local")
  if ! grep -Eq '^gvm use' <<< "$gvm_use_statement"
  then
    log_error "A .gvm_local file was detected, but it does not end with a 'gvm use' \
statement. Please ensure that the last line of the file starts with \
'gvm use'."
    return 1
  fi
  gvm_version_wanted=$(awk -F ' ' '{print $NF}' <<< "$gvm_use_statement")
  if ! test -z "$LOCAL_GVM_NAME" && test "$gvm_version_wanted" == "$LOCAL_GVM_NAME"
  then
    gvm_hook_check_mutex_unlock
    return 0
  fi

  source "${PWD}/.gvm_local" &&
    export IN_LOCAL_GVM=true &&
    export LOCAL_GVM_NAME="$gvm_version_wanted"
  gvm_hook_check_mutex_unlock
}

# Install Go if needed
# ====================
remove_dead_gvm_install_locks
grep -Eiq '^true$' <<< "$IN_LOCAL_GVM" && return 0

if ! test -d "$HOME/.gvm/gos/go$GOLANG_VERSION"
then
  log_info "Installing go$GOLANG_VERSION from source"
  # You need go to compile go (makes sense) but you can't install a binary version of it
  # if using MacOS Big Sur or above: https://github.com/moovweb/gvm/issues/360
  # FUCKING INSANE. I can't keep up with these kids, man.
  &>/dev/null which go || brew install go # To install literally any version of Go that can compile itself
  bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
  gvm install "go$GOLANG_VERSION"
fi
# shellcheck disable=SC1090
source ~/.gvm/scripts/gvm
gvm use "go$GOLANG_VERSION" >/dev/null

# Install the gopls engine (for Vim) and golangci-lint (for linting within Vim with Syntastic)
# =============================================================================================
for tool in $GOTOOLS
do
  name=$(cut -f1 -d ':' <<< "$tool")
  uri=$(cut -f2 -d ':' <<< "$tool")
  &>/dev/null which "$name" || go install "$uri"
done

# Uninstall the version of golang installed with Homebrew, as we no longer need it
# ==================================================================================
&>/dev/null brew ls --versions go && brew uninstall --ignore-dependencies go

# Set GOPATH if unset
# ===================
export PATH=$PATH:$GOROOT/bin
