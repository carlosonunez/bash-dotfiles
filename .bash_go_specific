#!/usr/bin/env bash
GOLANG_VERSION=1.17.1
GOTOOLS=$(cat <<-GOTOOLS
gopls:golang.org/x/tools/gopls@latest
golangci-lint:github.com/golangci/golangci-lint/cmd/golangci-lint@v1.42.1
GOTOOLS
)

# Install Go if needed
# ====================
if !  which go &> /dev/null
then
  # You need go to compile go (makes sense) but you can't install a binary version of it
  # if using MacOS Big Sur or above: https://github.com/moovweb/gvm/issues/360
  # FUCKING INSANE. I can't keep up with these kids, man.
  brew install go # To install literally any version of Go that can compile itself
  bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
fi
# shellcheck disable=SC1090
source ~/.gvm/scripts/gvm
gvm install "go$GOLANG_VERSION" && gvm use "go$GOLANG_VERSION"

# Install the gopls engine (for Vim) and golangci-lint (for linting within Vim with Syntastic)
# =============================================================================================
for tool in $GOTOOLS
do
  name=$(cut -f1 -d ':' <<< "$tool")
  uri=$(cut -f2 -d ':' <<< "$tool")
  2>/dev/null which "$name" || go install "$uri"
done

# Set up the Golang workspace if non-existent
# ============================================
GO_SRC_FOLDER="$HOME/src/go"
for subfolder in bin pkg src
do
  if [ ! -d "${GO_SRC_FOLDER}/${subfolder}" ]
  then
    mkdir -p "${GO_SRC_FOLDER}/${subfolder}"
  fi
done

# Set GOPATH if unset
# ===================
export GOPATH="${GO_SRC_FOLDER}"
export PATH=$PATH:$GOPATH/bin
