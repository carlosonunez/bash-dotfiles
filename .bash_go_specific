#!/usr/bin/env bash
export IN_LOCAL_GVM=false
GOLANG_VERSION=1.17.1
GOTOOLS=$(cat <<-GOTOOLS
gopls:golang.org/x/tools/gopls@latest
golangci-lint:github.com/golangci/golangci-lint/cmd/golangci-lint@v1.42.1
authy:github.com/momaek/authy@v0.1.7
GOTOOLS
)

gvm_hook() {
  if ! test -f "${PWD}/.gvm_local"
  then
    if grep -Eiq '^true$' <<< "$IN_LOCAL_GVM"
    then
      gvm use "go$GOLANG_VERSION" >/dev/null
    fi
    return 0
  fi
  
  gvm_use_statement=$(tail -1 "${PWD}/.gvm_local")
  if ! grep -Eq '^gvm use' <<< "$gvm_use_statement"
  then
    log_error "A .gvm_local file was detected, but it does not end with a 'gvm use' \
statement. Please ensure that the last line of the file starts with \
'gvm use'."
    return 1
  fi
  gvm_version_wanted=$(awk -F ' ' '{print $NF}' <<< "$gvm_use_statement")
  current_gvm_version=$(gvm list | grep -E '^=>' | awk -F' ' '{print $NF}')
  test "$gvm_version_wanted" == "$current_gvm_version" && return 0

  source "${PWD}/.gvm_local" && export IN_LOCAL_GVM=true
}

# Install Go if needed
# ====================
if ! test -d "$HOME/.gvm/gos/go$GOLANG_VERSION"
then
  log_info "Installing go$GOLANG_VERSION from source"
  # You need go to compile go (makes sense) but you can't install a binary version of it
  # if using MacOS Big Sur or above: https://github.com/moovweb/gvm/issues/360
  # FUCKING INSANE. I can't keep up with these kids, man.
  &>/dev/null which go || brew install go # To install literally any version of Go that can compile itself
  bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
  gvm install "go$GOLANG_VERSION"
fi
# shellcheck disable=SC1090
source ~/.gvm/scripts/gvm
gvm use "go$GOLANG_VERSION" >/dev/null

# Install the gopls engine (for Vim) and golangci-lint (for linting within Vim with Syntastic)
# =============================================================================================
for tool in $GOTOOLS
do
  name=$(cut -f1 -d ':' <<< "$tool")
  uri=$(cut -f2 -d ':' <<< "$tool")
  &>/dev/null which "$name" || go install "$uri"
done

# Uninstall the version of golang installed with Homebrew, as we no longer need it
# ==================================================================================
&>/dev/null brew ls --versions go && brew uninstall --ignore-dependencies go

# Set GOPATH if unset
# ===================
export PATH=$PATH:$GOROOT/bin
