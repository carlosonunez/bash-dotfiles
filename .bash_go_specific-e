#!/usr/bin/env bash
GOLANG_VERSION=1.17.1
GOTOOLS=$(cat <<-GOTOOLS
gopls:golang.org/x/tools/gopls@latest
golangci-lint:github.com/golangci/golangci-lint/cmd/golangci-lint@v1.42.1
authy:github.com/momaek/authy@v0.1.7
GOTOOLS
)

# Install Go if needed
# ====================
if !  which go &> /dev/null
then
  # You need go to compile go (makes sense) but you can't install a binary version of it
  # if using MacOS Big Sur or above: https://github.com/moovweb/gvm/issues/360
  # FUCKING INSANE. I can't keep up with these kids, man.
  brew install go # To install literally any version of Go that can compile itself
  bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
fi
# shellcheck disable=SC1090
source ~/.gvm/scripts/gvm
test -d "$HOME/.gvm/gos/go$GOLANG_VERSION" || gvm install "go$GOLANG_VERSION"
gvm use "go$GOLANG_VERSION" >/dev/null

# Install the gopls engine (for Vim) and golangci-lint (for linting within Vim with Syntastic)
# =============================================================================================
for tool in $GOTOOLS
do
  name=$(cut -f1 -d ':' <<< "$tool")
  uri=$(cut -f2 -d ':' <<< "$tool")
  &>/dev/null which "$name" || go install "$uri"
done

# Uninstall the version of golang installed with Homebrew, as we no longer need it
# ==================================================================================
&>/dev/null brew ls --versions go && brew uninstall --ignore-dependencies go

# Set GOPATH if unset
# ===================
export PATH=$PATH:$GOROOT/bin
