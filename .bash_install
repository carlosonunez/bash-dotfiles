# Update if we're running Ubuntu
# ===============================
if ! which python python3 >/dev/null
then
  if [ "$(get_os_type)" == "Ubuntu" ]
  then
    sudo apt-get update
  fi
  if ! install_application "python"
  then
    >&2 echo "ERROR: Couldn't install Python."
    return 1
  fi
fi

# Ensure that user-installed binaries are in our path.
# =====================================================
PYTHON2_LOCAL_DIR=$(echo $(python -c "import site; print(site.USER_BASE)")/bin)
PYTHON3_LOCAL_DIR=$(echo $(python3 -c "import site; print(site.USER_BASE)")/bin)

# Install pip
# ===========
if ! which pip3 &> /dev/null
then
  if ! {
    >&2 echo "INFO: Installing pip3. Hang on." &&
    curl https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py &&
    sudo python /tmp/get-pip.py;
  }
  then
    >&2 echo "ERROR: Couldn't install pip. Install it manually, then try again."
    return 1
  fi
fi

# Activate the venv
# ==================
if [ -z "$VIRTUAL_ENV" ] && [ ! -f "$PYTHON3_LOCAL_DIR/virtualenv" ]
then
  if ! pip3 install --user virtualenv
  then
    >&2 echo "ERROR: Couldn't install Python virtualenv."
    return 1
  fi
fi
if [ ! -d "$HOME/env/bin" ]
then
  $PYTHON3_LOCAL_DIR/virtualenv env
fi
source $HOME/env/bin/activate

# Install pygments
# ================
if [ "$(get_os_type)" != "Darwin" ]
then
  which pygmentize > /dev/null || {
    pip3 install pygments
    install_application "highlight"
  }
fi

# Install a few necessary brew formulae
# ======================================
[ "$(uname)" == "Darwin" ] && {
  builtin=$(echo "htop,tmux,jq,lastpass-cli" | tr "," "\n")
  casks=$(echo "google-chrome,shiftit,iterm2,slack" | tr "," "\n")
  for pkg in $builtin; do
    brew list "$pkg" 2>&1 > /dev/null || { echo "Installing: $pkg" && install_application "$pkg" ; }
  done
  for pkg in $casks; do
    brew cask list "$pkg" 2>&1 > /dev/null || { echo "Installing: $pkg" && install_application "Caskroom/cask/$pkg" ; }
  done
}
