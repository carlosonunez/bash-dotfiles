#!/usr/bin/env bash

check_for_internet_access() {
  test "$(curl -s --connect-timeout 3 http://nil.carlosnunez.me)" == "i love socks."
}

HOMEBREW_BUILTINS=$(cat <<-APPS
todo-txt
gnu-sed
htop
tmux
jq
feh
w3m
reattach-to-user-namespace
tree
mas
rtv
googler
docker-compose-completion
APPS
)
HOMEBREW_CASKS=$(cat <<-APPS
google-chrome
shiftit
iterm2
slack
1password
authy
xquartz
contexts
alfred
APPS
)
APPLE_STORE_APPS=$(cat <<-APPS
spark
shush
APPS
)

install_contexts_prefs() {
  cp ~/src/setup/com.contextsformac.Contexts.plist ~/Library/Preferences
}

install_shiftit_prefs() {
  defaults import org.shiftitapp.ShiftIt $HOME/src/setup/shiftit.plist
}

configure_todos() {
  if ! test -d $HOME/src/todos
  then
    git clone git@github.carlosnunez.me:carlosonunez/todos.git $HOME/src/todos
  fi
}

# Install NERD fonts and icons
# =============================
if ! brew cask list font-dejavusansmono-nerd-font &>/dev/null
then
  brew tap caskroom/fonts && brew cask install font-dejavusansmono-nerd-font
fi


# Install a few necessary brew formulae
# ======================================
installed_applications=$(brew list --full-name; \
  brew cask list --full-name 2>/dev/null; \
  find '/Applications' -maxdepth 1 \
    -name *.app \
    -exec sh -c 'basename "{}" | sed "s#\.app##" | tr "[:upper:]" "[:lower:]"' \;)
installed_pips=$(pip3 freeze)
[ "$(uname)" == "Darwin" ] && {
  for pkg in $HOMEBREW_BUILTINS; do
    if ! $(echo "$installed_applications" | grep -q "$pkg")
    then
      echo "INFO: Installing: $pkg"
      install_application "$pkg"
    fi
  done
  for pkg in $HOMEBREW_CASKS; do
    if ! $(echo "$installed_applications" | grep -q "$pkg")
    then
      echo "INFO: Installing: $pkg"
      brew cask install "$pkg"
    fi
  done
  if ! check_for_internet_access
  then
    >&2 echo "WARN: No internet access available. If you wish to install these \
Apple Store apps, connect to the internet and run 'source \$HOME/.bash_install'."
  else
    for pkg in $APPLE_STORE_APPS
    do
      if ! mas list | tr '[:upper:]' '[:lower:]' | grep -q "$pkg"
      then
        mas lucky "$pkg"
      fi
    done
  fi
  install_shiftit_prefs
  install_contexts_prefs
  configure_todos
}

# Export a few handy exports
# ==========================
